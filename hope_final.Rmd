---
title: "HTMN"
author: "Hope Miranda"
date: ""
output: 
  html_document:
    fig_height: 8
    fig_width: 12
---
<!-- Don't edit in between this line and the one below -->
```{r include=FALSE}
# Don't delete this chunk if you are using the DataComputing package
library(DataComputing)
library(car)
library(lubridate)
```
*Source file* 
```{r, results='asis', echo=FALSE}
includeSourceDocuments()
```
<!-- Don't edit the material above this line -->


```{r}
water_residential <- "/Users/Hope/Desktop/stats133/uw_supplier_data040416.csv"
new_water_residential <- water_residential  %>%
  read.file() %>%
  select(Supplier.Name, Stage.Invoked, Mandatory.Restrictions, 
         Reporting.Month, CALCULATED.R.GPCD.Reporting.Month..Values.calculated.by.Water.Board.staff.using.methodology.available.at.http...www.waterboards.ca.gov.waterrights.water_issues.programs.drought.docs.ws_tools.guidance_estimate_res_gpcd.pdf., Hydrologic.Region, Penalties.Assessed, X..Residential.Use)
```


```{r}
names(new_water_residential)[names(new_water_residential) == 'CALCULATED.R.GPCD.Reporting.Month..Values.calculated.by.Water.Board.staff.using.methodology.available.at.http...www.waterboards.ca.gov.waterrights.water_issues.programs.drought.docs.ws_tools.guidance_estimate_res_gpcd.pdf.'] <- 'resid_use'
```

```{r}
new_water_residential$Reporting.Month <- new_water_residential$Reporting.Month%>%
  mdy()
```


#Case Study: Bay Area Counties vs Los Angeles County, who is doing their part? 

```{r}
#los angeles water suppliers
#want all of los angeles county so any water supplier that matches the cities within LA county
#some gsub to get this nice list of the cities in LA county

lacities <- "Agoura Hills Alhambra Arcadia Artesia Avalon Azusa Baldwin Park Bell Bell Gardens Bellflower Beverly Hills Bradbury Burbank Calabasas Carson Cerritos Claremont Commerce Compton Covina Cudahy Culver City Diamond Bar Downey Duarte El Monte El Segundo Gardena Glendale Glendora Hawaiian Gardens Hawthorne Hermosa Beach Hidden Hills Huntington Park Industry Inglewood Irwindale La Cañada Flintridge La Habra Heights La Mirada La Puente La Verne Lakewood Lancaster Lawndale Lomita Long Beach Los Angeles Lynwood Malibu Manhattan Beach Maywood Monrovia Montebello Monterey Park Norwalk Palmdale Palos Verdes Estates Paramount Pasadena Pico Rivera Pomona Rancho Palos Verdes Redondo Beach Rolling Hills Rolling Hills Estates Rosemead San Dimas San Fernando San Gabriel San Marino Santa Clarita Santa Fe Springs Santa Monica Sierra Madre Signal Hill South El Monte South Gate South Pasadena Temple City Torrance Vernon Walnut West Covina West Hollywood Westlake Village Whittier"
lacities <- gsub(" " , ")|(" , lacities)

lacities

#NOT SHOWN:then manually put a . in between cities with more than one word in the name to account for spaces
#below is the dataset that only has los angeles county levels of water usage

losangeles.avg <- new_water_residential%>%
  filter(grepl("(Agoura.Hills)|(Alhambra)|(Arcadia)|(Artesia)|(Avalon)|(Azusa)|(Baldwin.Park)|(Bell)|(Bell.Gardens)|(Bellflower)|(Beverly.Hills)|(Bradbury)|(Burbank)|(Calabasas)|(Carson)|(Cerritos)|(Claremont)|(Commerce)|(Compton)|(Covina)|(Cudahy)|(Culver.City)|(Diamond.Bar)|(Downey)|(Duarte)|(El.Monte)|(El.Segundo)|(Gardena)|(Glendale)|(Glendora)|(Hawaiian)|(Gardens)|(Hawthorne)|(Hermosa.Beach)|(Hidden.Hills)|(Huntington.Park)|(Industry)|(Inglewood)|(Irwindale)|(La.Cañada.Flintridge)|(La.Habra.Heights)|(La.Mirada)|(La.Puente)|(La.Verne)|(Lakewood)|(Lancaster)|(Lawndale)|(Lomita)|(Long.Beach)|(Los.Angeles)|(Lynwood)|(Malibu)|(Manhattan.Beach)|(Maywood)|(Monrovia)|(Montebello)|(Monterey.Park)|(Norwalk)|(Palmdale)|(Palos.Verdes.Estates)|(Paramount)|(Pasadena)|(Pico.Rivera)|(Pomona)|(Rancho)|(Palos.Verdes)|(Redondo.Beach)|(Rolling.Hills)|(Rolling.Hills.Estates)|(Rosemead)|(San.Dimas)|(San.Fernando)|(San.Gabriel)|(San.Marino)|(Santa.Clarita)|(Santa.Fe.Springs)|(Santa.Monica)|(Sierra.Madre)|(Signal.Hill)|(South.El.Monte)|(South.Gate)|(South.Pasadena)|(Temple.City)|(Torrance)|(Vernon)|(Walnut)|(West.Covina)|(West.Hollywood)|(Westlake)|(Village)|(Whittier)", Supplier.Name))%>%
  group_by(Reporting.Month)%>%
  summarise(la_use_avg = mean(resid_use))
```


```{r}
#there are multiple counties surrounding the bay: SF, Marin, Sonoma, Napa, Solano, Contra Costa, Alameda, Santa Clara, and San Mateo. Eastbay

sfbay <- "Alameda, California
+ Albany, California
+ American Canyon, California
+ Antioch, California
+ Atherton, California
+ B
+ Belmont, California
+ Belvedere, California
+ Benicia, California
+ Berkeley, California
+ Brentwood, California
+ Brisbane, California
+ Burlingame, California
+ C
+ Calistoga, California
+ Campbell, California
+ Clayton, California
+ Cloverdale, California
+ Colma, California
+ Concord, California
+ Corte Madera, California
+ Cotati, California
+ Cupertino, California
+ D
+ Daly City, California
+ Danville, California
+ Dixon, California
+ Dublin, California
+ E
+ East Palo Alto, California
+ El Cerrito, California
+ Emeryville, California
+ F
+ Fairfax, California
+ Foster City, California
+ Fremont, California
+ G
+ Gilroy, California
+ H
+ Half Moon Bay, California
+ Hayward, California
+ Healdsburg, California
+ Hercules, California
+ Hillsborough, California
+ L
+ Lafayette, California
+ Larkspur, California
+ Livermore, California
+ Los Altos, California
+ Los Altos Hills, California
+ Los Gatos, California
+ M
+ Martinez, California
+ Menlo Park, California
+ Mill Valley, California
+ Millbrae, California
+ Milpitas, California
+ Monte Sereno, California
+ Moraga, California
+ Morgan Hill, California
+ Mountain View, California
+ N
+ Napa, California
+ Newark, California
+ Novato, California
+ O
+ Oakland, California
+ Oakley, California
+ Orinda, California
+ P
+ Pacifica, California
+ Palo Alto, California
+ Petaluma, California
+ Piedmont, California
+ Pinole, California
+ Pittsburg, California
+ Pleasant Hill, California
+ Pleasanton, California
+ Portola Valley, California
+ R
+ Redwood City, California
+ Richmond, California
+ Rio Vista, California
+ Rohnert Park, California
+ Ross, California
+ S
+ St. Helena, California
+ San Anselmo, California
+ San Carlos, California
+ San Francisco
+ San Jose, California
+ San Leandro, California
+ San Mateo, California
+ San Pablo, California
+ San Rafael, California
+ San Ramon, California
+ Santa Clara, California
+ Santa Rosa, California
+ Saratoga, California
+ Sausalito, California
+ Sebastopol, California
+ Sonoma, California
+ South San Francisco, California
+ Suisun City, California
+ Sunnyvale, California
+ T
+ Tiburon, California
+ U
+ Union City, California
+ V
+ Vacaville, California
+ Vallejo, California
+ W
+ Walnut Creek, California
+ Windsor, California
+ Woodside, California
+ Y
+ Yountville, California"

sfbay <- gsub("California", "", sfbay) #get rid of california
sfbay <- gsub("\n[A-Z]\n", "", sfbay) #get rid of the headers for each section of cities beginning with a certain letter
sfbay <- gsub("\n", "", sfbay) #getting rid of extra newlines
sfbay <- gsub(", " , ")|(", sfbay) #inputting the separations for when I use grepl later

sfbay  #want to look at it so I can copy/paste and make small edits for when I use it in grepl


bayavg <-  new_water_residential%>%
  filter(grepl( "(Alameda)|(Albany)|(American.Canyon)|(Antioch)|(Atherton)|(Belmont)|(Belvedere)|(Benicia)|(Berkeley)|(Brentwood)|(Brisbane)|(Burlingame)|(Calistoga)|(Campbell)|(Clayton)|(Cloverdale)|(Colma)|(Concord)|(Corte.Madera)|(Cotati)|(Cupertino)|(Daly.City)|(Danville)|(Dixon)|(Dublin)|(East.Palo.Alto)|(El.Cerrito)|(Emeryville)|(Fairfax)|(Foster.City)|(Fremont)|(Gilroy)|(Half.Moon.Bay)|(Hayward)|(Healdsburg)|(Hercules)|(Hillsborough)|(Lafayette)|(Larkspur)|(Livermore)|(Los.Altos)|(Los.Altos.Hills)|(Los.Gatos)|(Martinez)|(Menlo.Park)|(Mill.Valley)|(Millbrae)|(Milpitas)|(Monte.Sereno)|(Moraga)|(Morgan.Hill)|(Mountain.View)|(Napa)|(Newark)|(Novato)|(Oakland)|(Oakley)|(Orinda)|(Pacifica)|(Palo.Alto)|(Petaluma)|(Piedmont)|(Pinole)|(Pittsburg)|(Pleasant.Hill)|(Pleasanton)|(Portola.Valley)|(Redwood.City)|(Richmond)|(Rio.Vista)|(Rohnert.Park)|(Ross)|(St..Helena)|(San.Anselmo)|(San.Carlos)|(San.FranciscoSan.Jose)|(San.Leandro)|(San.Mateo)|(San.Pablo)|(San.Rafael)|(San.Ramon)|(Santa.Clara)|(Santa.Rosa)|(Saratoga)|(Sausalito)|(Sebastopol)|(Sonoma)|(South.San.Francisco)|(Suisun.City)|(Sunnyvale)|(Tiburon)|(Union.City)|(Vacaville)|(Vallejo)|(Walnut.Creek)|(Windsor)|(Woodside)|(Yountville)|(East.Bay)", Supplier.Name ))%>%
  group_by(Reporting.Month)%>%
  summarise(bay_use_avg = mean(resid_use))

```

```{r}
# we want to compare to california as a whole so let's take the average for every month for the whole state!

state.avg <- new_water_residential%>%
  group_by(Reporting.Month)%>%
  summarise(state_use_avg = mean(resid_use))
```

Now let's combine all three of these datasets so that we have just one dataset we're plotting from

```{r}
la_state <- state.avg%>%
  inner_join(losangeles.avg, by = c("Reporting.Month" = "Reporting.Month"))

alljoined <- la_state%>%
  inner_join(bayavg, by = c("Reporting.Month" = "Reporting.Month"))

#now that I have everything joined, I have to make it tidy
#using gather to make it narrow

narrowall <- alljoined%>%
  gather(key = boundary, value = avg_resid_use, state_use_avg, la_use_avg, bay_use_avg)

```

Time to plot!

```{r}
  ggplot(narrowall, aes(x=Reporting.Month, y= avg_resid_use, color = boundary)) +
  geom_point() + 
  stat_smooth(se=FALSE, method="loess") +
  labs(x = "Month", y = "Average Residential Water Usage", title = "Water Usage vs Month: in LA County and all 9 Bay Area Counties") +
  theme_minimal() + 
  theme(plot.title = element_text(size = 25),
        axis.title.x = element_text(size = 18),
        axis.title.y = element_text(size = 18) 
        )
```

##Analysis of Case Study

initial analysis: install





#drought severity in California over time

```{r}
#install.packages("mapdata")
#install.packages("ggmap")
library(mapdata)
library(ggmap)

#data set that has drought by county

drought_severity <- "/Users/Hope/Desktop/stats133/countydroughtseverity.csv"
drought_severity <- drought_severity%>%
  read.file()
drought_severity$county <- gsub(" County", "", drought_severity$county)
drought_severity$county <- sapply(drought_severity$county, tolower)

names(drought_severity)[names(drought_severity) == "county"] <- "subregion"
drought_severity <- data.frame(drought_severity)

#adding month and year column for later
drought_severity$releaseDate <- as.Date(drought_severity$releaseDate)
drought_severity$month <- months(drought_severity$releaseDate)
drought_severity$year <- year(ymd(drought_severity$releaseDate)) 

```


```{r}
#only taking the highest drought severity for each date



#narrow version of drought_severity only with 2000, 2005, 2010, 2011, 2012, 2013, 2014, 2015
#taking the average for each month for each category of severity for simplicity
#
#  filter(year == "2000" | year == "2005" | year == "2010" | year == "2011" | year == "2012" | year == "2013" | year == "2014" | year == "2015" | year =="2016")%>%
#  filter(month == "February" | month == "May" | month == "August" | month == "November")%>%
  
tidy_severity <- drought_severity%>%
  gather(key = category, value = value, NONE, D0, D1, D2, D3, D4)%>%
  select(subregion, month, year, category, value)%>%
    group_by(month, year, subregion, category)%>%
  summarise(ave_value = mean(value))

#just making sure everything is in the correct format for ease of plotting
tidy_severity <- data.frame(tidy_severity)
tidy_severity$year <- as.numeric(tidy_severity$year)



#coordinates for the california counties
CAcounties <- map_data('county')%>%
  filter(region == "california")
CAcounties <- data.frame(CAcounties)


#merge drought information with coordinates for each county
CAcountiesvalues <- CAcounties%>%
  right_join(tidy_severity, by = "subregion")


#creating levels for mapping later
CAcountiesvalues$category <- factor(CAcountiesvalues$category, levels = c("D4", "D3", "D2", "D1", "D0", "NONE"))

CAcountiesvalues$month <- factor(CAcountiesvalues$month, levels = c("January", "February", "March", "April", "May","June", "July", "August","September", "October", "November","December"))

```



```{r, eval = FALSE}
#smaller data sets for specific months and years

#february 2000
feb2000 <- CAcountiesvalues%>%
  filter(month == "February", year == 0)
#may 2000
may2000 <- CAcountiesvalues%>%
  filter(month == "May", year == 0)
#august 2000
aug2000 <- CAcountiesvalues%>%
  filter(month == "August", year == 0)
#november 2000
nov2000 <- CAcountiesvalues%>%
  filter(month == "November", year == 0)



#february 2010
feb2010 <- CAcountiesvalues%>%
  filter(month == "February", year == 10)
#may 2010
may2010 <- CAcountiesvalues%>%
  filter(month == "May", year == 10)
#august 2010
aug2010 <- CAcountiesvalues%>%
  filter(month == "August", year == 10)
#november 2010
nov2010 <- CAcountiesvalues%>%
  filter(month == "November", year == 10)


#february 2014
feb2014 <- CAcountiesvalues%>%
  filter(month == "February", year == 14)
#may 2014
may2014 <- CAcountiesvalues%>%
  filter(month == "May", year == 14)
#august 2014
aug2014 <- CAcountiesvalues%>%
  filter(month == "August", year == 14)
#november 2014
nov2014 <- CAcountiesvalues%>%
  filter(month == "November", year == 14)


nov2014$category <- factor(nov2014$category, levels = c("NONE", "D0", "D1", "D2", "D3", "D4"))
```



```{r}

#gonna try to make an even simpler thing to work with, so only the highest severity value is kept 

untidy <- tidy_severity%>%
  spread(key = category, value = ave_value)

#november 2014
nov2014 <- CAcountiesvalues%>%
  filter(month == "November", year == 14)


nov2014$category <- factor(nov2014$category, levels = c("NONE", "D0", "D1", "D2", "D3", "D4"))

```



```{r}

#this doesn't actually work yet, not sure if I'm going to try to make it work
#gonna try to plot different months/years

#trying to plot here, testing different data and map info needed


#ggplot() +
#  geom_polygon(data = CAcountiesvalues, aes(x = long, y = lat, group = group, fill = ave_value), color = "black", size = 0.25) + scale_fill_gradient(low = "blue", high = "red") + stat_density2d(data = CAcountiesvalues, aes(x = long, y = lat, fill = ..level.., alpha = ..level..), size = 2, bins = 5, geom = "polygon") + 
#  facet_grid(month ~year) + 
#  theme(axis.line=element_blank(),axis.text.x=element_blank(),axis.text.y=element_blank(),axis.ticks=element_blank(), legend.position="none")


#ggplot() +   
#  geom_polygon(data = may2000, aes(x = long, y = lat, group = group), color = "grey80", fill = "grey80", size = .1) + 
#  stat_density2d(data = may2000, aes(x = long, y = lat, color = category, fill = category, alpha = ..level..), size = .1,  geom = "polygon") + scale_fill_gradient(low = "yellow", high = "red") + 
#    theme(axis.line=element_blank(),axis.text.x=element_blank(),axis.text.y=element_blank(),axis.ticks=element_blank(), legend.position="none")
```



```{r}
#ggplot() + geom_polygon(data = feb2014, aes(x = long, y = lat, group = group,colour = category, alpha = ave_value), color = "black", size = 0.25)  + scale_colour_manual(values=c("firebrick4", "orangered3", "darkorange2", "orange", "yellow1", "snow3")) +  scale_alpha_discrete(range = c(0, 1)) + theme(axis.line=element_blank(),axis.text.x=element_blank(),axis.text.y=element_blank(),axis.ticks=element_blank(), legend.position="none")


#ggplot() + geom_polygon(data = CAcounties, aes(x = long, y = lat, group = group), colour = "grey70", size = 0.25) + geom_polygon(data = feb2014, mapping = aes(x = long, y = lat, group=group, fill = category, alpha = ave_value))+ scale_fill_manual(values=c("firebrick4", "orangered3", "darkorange2", "orange", "yellow1", "snow"))

```


```{r}

#okay so this makes the really large grid with many maps, may just use this as an overview, then take pieces from it?

CAcountiesvalues%>% 
  ggplot() + 
  geom_polygon(aes (x = long, y = lat, group = group, fill = ave_value), colour = "white", size = 0.02)+ scale_fill_gradient(low = "yellow", high = "red") + 
  facet_grid(category ~ year) +
  labs(x = "Year", y = "Drought Severity", title = "Drought Severity Over Key Years") +
  theme(axis.line=element_blank(),axis.text.x=element_blank(),axis.text.y=element_blank(),axis.ticks=element_blank())
```

Overview analysis: 


```{r}


```


In depth analysis:
